<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åå°ç®¡ç† - ä¸“æ³¨åŠ›è®­ç»ƒç³»ç»Ÿ</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background: #f5f5f5;
            font-family: 'Microsoft YaHei', Arial, sans-serif;
        }
        .navbar {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
        }
        .navbar-brand {
            font-size: 24px;
            font-weight: bold;
            color: white !important;
        }
        .container {
            margin-top: 30px;
        }
        .stat-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
        }
        .stat-card h3 {
            color: #667eea;
            font-size: 48px;
            font-weight: bold;
            margin: 10px 0;
        }
        .stat-card p {
            color: #666;
            font-size: 16px;
        }
        .table-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .btn-action {
            margin: 0 5px;
            padding: 5px 15px;
            font-size: 14px;
        }
        
        .stat-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(0,0,0,0.15);
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #999;
        }
        
        .table-container h4 {
            color: #764ba2;
            margin-bottom: 20px;
        }
        
        .pagination button:disabled {
            cursor: not-allowed;
        }
        
        /* å¯†ç é‡ç½®æ¨¡æ€æ¡† */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-overlay.show {
            display: flex;
        }
        
        .password-modal {
            background: white;
            border-radius: 15px;
            padding: 30px;
            width: 450px;
            max-width: 90%;
            box-shadow: 0 10px 40px rgba(0,0,0,0.3);
            animation: modalSlideIn 0.3s ease-out;
        }
        
        @keyframes modalSlideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-header h5 {
            margin: 0;
            color: #667eea;
            font-size: 20px;
            font-weight: bold;
        }
        
        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            line-height: 1;
        }
        
        .modal-close:hover {
            color: #333;
        }
        
        .password-input-group {
            position: relative;
            margin-bottom: 15px;
        }
        
        .password-input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        
        .password-input-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .password-strength {
            margin-top: 10px;
            height: 4px;
            background: #e0e0e0;
            border-radius: 2px;
            overflow: hidden;
        }
        
        .password-strength-bar {
            height: 100%;
            width: 0;
            transition: width 0.3s, background-color 0.3s;
        }
        
        .password-strength-bar.weak {
            width: 33%;
            background: #f5576c;
        }
        
        .password-strength-bar.medium {
            width: 66%;
            background: #f093fb;
        }
        
        .password-strength-bar.strong {
            width: 100%;
            background: #4facfe;
        }
        
        .password-hint {
            margin-top: 8px;
            font-size: 13px;
            color: #999;
        }
        
        .password-hint.error {
            color: #f5576c;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .btn-modal {
            padding: 10px 25px;
            border: none;
            border-radius: 8px;
            font-size: 15px;
            cursor: pointer;
            transition: opacity 0.3s;
        }
        
        .btn-modal:hover {
            opacity: 0.8;
        }
        
        .btn-modal-cancel {
            background: #e0e0e0;
            color: #666;
        }
        
        .btn-modal-confirm {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-modal-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* ç§»åŠ¨ç«¯é€‚é… */
        @media (max-width: 768px) {
            .navbar {
                padding: 10px 15px;
            }
            
            .navbar-brand {
                font-size: 18px;
            }
            
            .navbar .text-white {
                font-size: 14px;
            }
            
            .container {
                margin-top: 15px;
                padding: 0 10px;
            }
            
            .stat-card {
                padding: 15px;
                margin-bottom: 15px;
            }
            
            .stat-card h3 {
                font-size: 36px;
            }
            
            .stat-card p {
                font-size: 14px;
            }
            
            .table-container {
                padding: 15px;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .table-container h4 {
                font-size: 18px;
            }
            
            .table {
                font-size: 12px;
            }
            
            .table th,
            .table td {
                padding: 8px 5px;
                white-space: nowrap;
            }
            
            .btn-action {
                margin: 2px;
                padding: 3px 8px;
                font-size: 12px;
            }
            
            .badge {
                font-size: 11px;
            }
        }
        
        @media (max-width: 480px) {
            .navbar-brand {
                font-size: 16px;
            }
            
            .stat-card h3 {
                font-size: 32px;
            }
            
            .table {
                font-size: 11px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="container-fluid">
            <span class="navbar-brand">ğŸ¯ ä¸“æ³¨åŠ›è®­ç»ƒç³»ç»Ÿ - åå°ç®¡ç†</span>
            <div>
                <span class="text-white me-3">ç®¡ç†å‘˜ï¼š<span id="adminName"></span></span>
                <button class="btn btn-light btn-sm" onclick="logout()">é€€å‡º</button>
            </div>
        </div>
    </nav>

    <div class="container">
        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <p>æ€»ç”¨æˆ·æ•°</p>
                    <h3 id="totalUsers">0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                    <p>æ€»è®­ç»ƒæ¬¡æ•°</p>
                    <h3 id="totalRecords">0</h3>
                </div>
            </div>
            <div class="col-md-4">
                <div class="stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white;">
                    <p>æ´»è·ƒç”¨æˆ·æ•°</p>
                    <h3 id="activeUsers">0</h3>
                </div>
            </div>
        </div>

        <!-- ç”¨æˆ·ç®¡ç† -->
        <div class="table-container mb-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">ç”¨æˆ·ç®¡ç†</h4>
                <button class="btn btn-primary btn-sm" onclick="loadUsers(currentPage)">
                    <span>ğŸ”„</span> åˆ·æ–°
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>é‚®ç®±</th>
                            <th>è§’è‰²</th>
                            <th>çŠ¶æ€</th>
                            <th>æ³¨å†Œæ—¶é—´</th>
                            <th>æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="userTableBody">
                        <tr>
                            <td colspan="7" class="loading">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <p class="mt-2">æ­£åœ¨åŠ è½½ç”¨æˆ·æ•°æ®...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="pagination" class="text-center mt-3"></div>
        </div>

        <!-- è®­ç»ƒè®°å½• -->
        <div class="table-container">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4 class="mb-0">è¿‘æœŸè®­ç»ƒè®°å½•</h4>
                <button class="btn btn-success btn-sm" onclick="loadRecords(currentRecordPage)">
                    <span>ğŸ”„</span> åˆ·æ–°
                </button>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>ç”¨æˆ·å</th>
                            <th>è®­ç»ƒç±»å‹</th>
                            <th>éš¾åº¦</th>
                            <th>å¾—åˆ†</th>
                            <th>å‡†ç¡®ç‡</th>
                            <th>è€—æ—¶(ç§’)</th>
                            <th>å®Œæˆæ—¶é—´</th>
                        </tr>
                    </thead>
                    <tbody id="recordTableBody">
                        <tr>
                            <td colspan="8" class="loading">
                                <div class="spinner-border text-success" role="status">
                                    <span class="visually-hidden">åŠ è½½ä¸­...</span>
                                </div>
                                <p class="mt-2">æ­£åœ¨åŠ è½½è®­ç»ƒè®°å½•...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <div id="recordPagination" class="text-center mt-3"></div>
        </div>
    </div>

    <!-- å¯†ç é‡ç½®æ¨¡æ€æ¡† -->
    <div id="passwordModal" class="modal-overlay">
        <div class="password-modal">
            <div class="modal-header">
                <h5>é‡ç½®ç”¨æˆ·å¯†ç </h5>
                <button class="modal-close" onclick="closePasswordModal()">&times;</button>
            </div>
            <div class="modal-body">
                <p style="color: #666; margin-bottom: 15px;">æ­£åœ¨ä¸ºç”¨æˆ· <strong id="resetUsername"></strong> é‡ç½®å¯†ç </p>
                <div class="password-input-group">
                    <input type="password" id="newPasswordInput" placeholder="è¯·è¾“å…¥æ–°å¯†ç ï¼ˆè‡³å°‘6ä½å­—ç¬¦ï¼‰" autocomplete="off">
                    <div class="password-strength">
                        <div id="strengthBar" class="password-strength-bar"></div>
                    </div>
                    <div id="passwordHint" class="password-hint">å¯†ç é•¿åº¦è‡³å°‘6ä½å­—ç¬¦</div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal btn-modal-cancel" onclick="closePasswordModal()">å–æ¶ˆ</button>
                <button id="confirmResetBtn" class="btn-modal btn-modal-confirm" onclick="confirmResetPassword()" disabled>ç¡®è®¤é‡ç½®</button>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentPage = 0;
        let currentRecordPage = 0;
        const pageSize = 10;

        // æ£€æŸ¥ç™»å½•çŠ¶æ€
        async function checkLogin() {
            try {
                const response = await fetch('/api/auth/current');
                const data = await response.json();
                
                if (data.status !== 'SUCCESS') {
                    // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µ
                    showLoginTip('æ‚¨è¿˜æœªç™»å½•ï¼Œè¯·å…ˆç™»å½•');
                    setTimeout(() => {
                        window.location.href = '/login.html';
                    }, 2000);
                    return false;
                }
                
                if (data.data.role !== 'ADMIN') {
                    // ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæç¤ºå¹¶è·³è½¬
                    showLoginTip('æ‚¨ä¸æ˜¯ç®¡ç†å‘˜ï¼Œæ— æƒè®¿é—®æ­¤é¡µé¢');
                    setTimeout(() => {
                        window.location.href = '/index.html';
                    }, 2000);
                    return false;
                }
                
                document.getElementById('adminName').textContent = data.data.username;
                return true;
            } catch (error) {
                console.error('æ£€æŸ¥ç™»å½•å¤±è´¥:', error);
                showLoginTip('ç™»å½•çŠ¶æ€éªŒè¯å¤±è´¥ï¼Œè¯·é‡æ–°ç™»å½•');
                setTimeout(() => {
                    window.location.href = '/login.html';
                }, 2000);
                return false;
            }
        }
        
        // æ˜¾ç¤ºç™»å½•æç¤º
        function showLoginTip(message) {
            const tip = document.createElement('div');
            tip.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: white;
                padding: 30px 50px;
                border-radius: 15px;
                box-shadow: 0 10px 40px rgba(0,0,0,0.3);
                z-index: 9999;
                text-align: center;
                font-size: 18px;
                color: #667eea;
            `;
            tip.innerHTML = `
                <div style="margin-bottom: 15px;">
                    <svg width="50" height="50" viewBox="0 0 24 24" fill="#667eea">
                        <path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-2h2v2zm0-4h-2V7h2v6z"/>
                    </svg>
                </div>
                <div>${message}</div>
                <div style="margin-top: 10px; font-size: 14px; color: #999;">æ­£åœ¨è·³è½¬...</div>
            `;
            document.body.appendChild(tip);
        }

        // åŠ è½½ç»Ÿè®¡ä¿¡æ¯
        async function loadStatistics() {
            try {
                const response = await fetch('/api/admin/statistics');
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    document.getElementById('totalUsers').textContent = data.data.totalUsers;
                    document.getElementById('totalRecords').textContent = data.data.totalRecords;
                    
                    // è®¡ç®—æ´»è·ƒç”¨æˆ·(æœ‰è®­ç»ƒè®°å½•çš„ç”¨æˆ·)
                    const activeUsers = data.data.recentUsers ? data.data.recentUsers.length : 0;
                    document.getElementById('activeUsers').textContent = activeUsers;
                    
                    // æ·»åŠ åŠ¨ç”»æ•ˆæœ
                    animateValue('totalUsers', 0, data.data.totalUsers, 1000);
                    animateValue('totalRecords', 0, data.data.totalRecords, 1000);
                    animateValue('activeUsers', 0, activeUsers, 1000);
                }
            } catch (error) {
                console.error('åŠ è½½ç»Ÿè®¡ä¿¡æ¯å¤±è´¥', error);
            }
        }
        
        // æ•°å­—åŠ¨ç”»
        function animateValue(id, start, end, duration) {
            const element = document.getElementById(id);
            const range = end - start;
            const increment = range / (duration / 16);
            let current = start;
            
            const timer = setInterval(() => {
                current += increment;
                if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                    element.textContent = end;
                    clearInterval(timer);
                } else {
                    element.textContent = Math.floor(current);
                }
            }, 16);
        }

        // åŠ è½½ç”¨æˆ·åˆ—è¡¨
        async function loadUsers(page = 0) {
            currentPage = page;
            try {
                const response = await fetch(`/api/admin/users?page=${page}&size=${pageSize}`);
                const data = await response.json();
                        
                if (data.status === 'SUCCESS') {
                    const tbody = document.getElementById('userTableBody');
                    tbody.innerHTML = '';
                            
                    if (data.data.users.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-4">æš‚æ— ç”¨æˆ·æ•°æ®</td></tr>`;
                        return;
                    }
                            
                    data.data.users.forEach(user => {
                        const tr = document.createElement('tr');
                        const createdAt = new Date(user.createdAt).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                                
                        tr.innerHTML = `
                            <td>${user.id}</td>
                            <td><strong>${user.username}</strong></td>
                            <td>${user.email || '<span class="text-muted">-</span>'}</td>
                            <td><span class="badge ${user.role === 'ADMIN' ? 'bg-danger' : 'bg-primary'}">${user.role}</span></td>
                            <td><span class="badge ${user.status === 1 ? 'bg-success' : 'bg-secondary'}">${user.status === 1 ? 'æ­£å¸¸' : 'ç¦ç”¨'}</span></td>
                            <td>${createdAt}</td>
                            <td>
                                <button class="btn btn-sm btn-${user.status === 1 ? 'warning' : 'success'} btn-action" 
                                        onclick="toggleStatus(${user.id}, ${user.status})"
                                        ${user.role === 'ADMIN' ? 'disabled title="ä¸èƒ½ç¦ç”¨ç®¡ç†å‘˜"' : ''}>
                                    ${user.status === 1 ? 'ç¦ç”¨' : 'å¯ç”¨'}
                                </button>
                                <button class="btn btn-sm btn-danger btn-action" 
                                        onclick="deleteUser(${user.id}, '${user.username}')"
                                        ${user.role === 'ADMIN' ? 'disabled title="ä¸èƒ½åˆ é™¤ç®¡ç†å‘˜"' : ''}>
                                    åˆ é™¤
                                </button>
                                <button class="btn btn-sm btn-info btn-action" onclick="resetPassword(${user.id}, '${user.username}')">é‡ç½®å¯†ç </button>
                            </td>
                        `;
                        tbody.appendChild(tr);
                    });
        
                    // åˆ†é¡µ
                    const totalPages = Math.ceil(data.data.total / pageSize);
                    renderPagination(totalPages, page);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('åŠ è½½ç”¨æˆ·åˆ—è¡¨å¤±è´¥', error);
                const tbody = document.getElementById('userTableBody');
                tbody.innerHTML = `<tr><td colspan="7" class="text-center text-danger py-4">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
            }
        }

        // æ¸²æŸ“åˆ†é¡µ
        function renderPagination(totalPages, currentPage) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';
            
            for (let i = 0; i < totalPages; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentPage ? 'btn-primary' : 'btn-outline-primary'} me-1`;
                btn.textContent = i + 1;
                btn.onclick = () => loadUsers(i);
                pagination.appendChild(btn);
            }
        }

        // åˆ‡æ¢ç”¨æˆ·çŠ¶æ€
        async function toggleStatus(userId, currentStatus) {
            const newStatus = currentStatus === 1 ? 0 : 1;
            const action = newStatus === 1 ? 'å¯ç”¨' : 'ç¦ç”¨';
            
            if (!confirm(`ç¡®å®šè¦${action}è¯¥ç”¨æˆ·å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}/status`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({status: newStatus})
                });
                
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    alert(`${action}æˆåŠŸï¼`);
                    loadUsers(currentPage);
                } else {
                    alert('æ“ä½œå¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                alert('æ“ä½œå¤±è´¥ï¼š' + error.message);
            }
        }

        // åˆ é™¤ç”¨æˆ·
        async function deleteUser(userId, username) {
            if (!confirm(`ç¡®å®šè¦åˆ é™¤ç”¨æˆ· "${username}" å—ï¼Ÿ\n\næ­¤æ“ä½œä¸å¯æ¢å¤ï¼`)) return;
            
            try {
                const response = await fetch(`/api/admin/users/${userId}`, {
                    method: 'DELETE'
                });
                
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    alert('åˆ é™¤æˆåŠŸï¼');
                    loadUsers(currentPage);
                    loadStatistics();
                } else {
                    alert('åˆ é™¤å¤±è´¥ï¼š' + data.message);
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + error.message);
            }
        }

        // å¯†ç é‡ç½®ç›¸å…³å˜é‡
        let currentResetUserId = null;
        let currentResetUsername = null;
        
        // é‡ç½®å¯†ç  - æ‰“å¼€æ¨¡æ€æ¡†
        function resetPassword(userId, username) {
            currentResetUserId = userId;
            currentResetUsername = username;
            document.getElementById('resetUsername').textContent = username;
            document.getElementById('newPasswordInput').value = '';
            document.getElementById('strengthBar').className = 'password-strength-bar';
            document.getElementById('passwordHint').textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä½å­—ç¬¦';
            document.getElementById('passwordHint').className = 'password-hint';
            document.getElementById('confirmResetBtn').disabled = true;
            document.getElementById('passwordModal').classList.add('show');
            
            // ç„¦ç‚¹åˆ°è¾“å…¥æ¡†
            setTimeout(() => {
                document.getElementById('newPasswordInput').focus();
            }, 100);
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.remove('show');
            currentResetUserId = null;
            currentResetUsername = null;
        }
        
        // å¯†ç å¼ºåº¦æ£€æµ‹
        function checkPasswordStrength(password) {
            const strengthBar = document.getElementById('strengthBar');
            const hint = document.getElementById('passwordHint');
            const confirmBtn = document.getElementById('confirmResetBtn');
            
            if (password.length === 0) {
                strengthBar.className = 'password-strength-bar';
                hint.textContent = 'å¯†ç é•¿åº¦è‡³å°‘6ä½å­—ç¬¦';
                hint.className = 'password-hint';
                confirmBtn.disabled = true;
                return;
            }
            
            if (password.length < 6) {
                strengthBar.className = 'password-strength-bar';
                hint.textContent = 'å¯†ç å¤ªçŸ­ï¼Œè‡³å°‘éœ€è¦6ä½å­—ç¬¦';
                hint.className = 'password-hint error';
                confirmBtn.disabled = true;
                return;
            }
            
            // è®¡ç®—å¯†ç å¼ºåº¦
            let strength = 0;
            if (password.length >= 8) strength++;
            if (/[a-z]/.test(password) && /[A-Z]/.test(password)) strength++;
            if (/\d/.test(password)) strength++;
            if (/[^a-zA-Z\d]/.test(password)) strength++;
            
            if (strength <= 1) {
                strengthBar.className = 'password-strength-bar weak';
                hint.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼±';
                hint.className = 'password-hint';
                hint.style.color = '#f5576c';
            } else if (strength === 2) {
                strengthBar.className = 'password-strength-bar medium';
                hint.textContent = 'å¯†ç å¼ºåº¦ï¼šä¸­ç­‰';
                hint.className = 'password-hint';
                hint.style.color = '#f093fb';
            } else {
                strengthBar.className = 'password-strength-bar strong';
                hint.textContent = 'å¯†ç å¼ºåº¦ï¼šå¼º';
                hint.className = 'password-hint';
                hint.style.color = '#4facfe';
            }
            
            confirmBtn.disabled = false;
        }
        
        // ç¡®è®¤é‡ç½®å¯†ç 
        async function confirmResetPassword() {
            const newPassword = document.getElementById('newPasswordInput').value;
            
            if (newPassword.length < 6) {
                alert('å¯†ç é•¿åº¦ä¸èƒ½å°‘äº6ä½ï¼');
                return;
            }
            
            const confirmBtn = document.getElementById('confirmResetBtn');
            confirmBtn.disabled = true;
            confirmBtn.textContent = 'é‡ç½®ä¸­...';
            
            try {
                const response = await fetch(`/api/admin/users/${currentResetUserId}/password`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({password: newPassword})
                });
                
                const data = await response.json();
                if (data.status === 'SUCCESS') {
                    closePasswordModal();
                    alert('å¯†ç é‡ç½®æˆåŠŸï¼');
                } else {
                    alert('é‡ç½®å¤±è´¥ï¼š' + data.message);
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'ç¡®è®¤é‡ç½®';
                }
            } catch (error) {
                alert('é‡ç½®å¤±è´¥ï¼š' + error.message);
                confirmBtn.disabled = false;
                confirmBtn.textContent = 'ç¡®è®¤é‡ç½®';
            }
        }

        // é€€å‡ºç™»å½•
        async function logout() {
            if (!confirm('ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ')) return;
            
            try {
                await fetch('/api/auth/logout', {method: 'POST'});
                window.location.href = '/login.html';
            } catch (error) {
                window.location.href = '/login.html';
            }
        }
        
        // åŠ è½½è®­ç»ƒè®°å½•
        async function loadRecords(page = 0) {
            currentRecordPage = page;
            try {
                const response = await fetch(`/api/admin/records?page=${page}&size=${pageSize}`);
                const data = await response.json();
                
                if (data.status === 'SUCCESS') {
                    const tbody = document.getElementById('recordTableBody');
                    tbody.innerHTML = '';
                    
                    if (data.data.records.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="8" class="text-center text-muted py-4">æš‚æ— è®­ç»ƒè®°å½•</td></tr>`;
                        return;
                    }
                    
                    data.data.records.forEach(record => {
                        const tr = document.createElement('tr');
                        const completedAt = new Date(record.completedAt).toLocaleString('zh-CN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit',
                            hour: '2-digit',
                            minute: '2-digit'
                        });
                        
                        const trainingTypeMap = {
                            'ARROW_TRACKING': 'ç®­å¤´è¿½è¸ª',
                            'NUMBER_REPETITION': 'æ•°å­—æŸ¥æ‰¾',
                            'ANIMAL_NUMBER_MATCH': 'åŠ¨ç‰©åŒ¹é…',
                            'HIDDEN_OBJECT': 'å¯»å®æ¸¸æˆ',
                            'NUMBER_COMPARE': 'æ•°å­—å¯¹æ¯”',
                            'SCHULTZ_TABLE': 'èˆ’å°”ç‰¹æ–¹æ ¼',
                            'SYMBOL_MATRIX': 'ç¬¦å·çŸ©é˜µ',
                            'NUMBER_MIGRATION': 'æ•°å­—è¿ç§»'
                        };
                        
                        const difficultyMap = {1: 'ä½', 2: 'ä¸­', 3: 'é«˜'};
                        
                        tr.innerHTML = `
                            <td>${record.id}</td>
                            <td>
                                <strong>${record.username || 'æœªçŸ¥ç”¨æˆ·'}</strong>
                                <span class="text-muted small d-block">ID: ${record.userId}</span>
                            </td>
                            <td>${trainingTypeMap[record.trainingType] || record.trainingType}</td>
                            <td><span class="badge bg-${record.difficultyLevel === 3 ? 'danger' : record.difficultyLevel === 2 ? 'warning' : 'success'}">
                                ${difficultyMap[record.difficultyLevel] || record.difficultyLevel}
                            </span></td>
                            <td><strong>${record.score ? record.score.toFixed(1) : '-'}</strong></td>
                            <td>${record.accuracyRate ? (record.accuracyRate.toFixed(1) + '%') : '-'}</td>
                            <td>${record.timeSpent || '-'}</td>
                            <td>${completedAt}</td>
                        `;
                        tbody.appendChild(tr);
                    });
                    
                    // åˆ†é¡µ
                    const totalPages = Math.ceil(data.data.total / pageSize);
                    renderRecordPagination(totalPages, page);
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('åŠ è½½è®­ç»ƒè®°å½•å¤±è´¥', error);
                const tbody = document.getElementById('recordTableBody');
                tbody.innerHTML = `<tr><td colspan="8" class="text-center text-danger py-4">åŠ è½½å¤±è´¥ï¼š${error.message}</td></tr>`;
            }
        }
        
        // æ¸²æŸ“è®­ç»ƒè®°å½•åˆ†é¡µ
        function renderRecordPagination(totalPages, currentPage) {
            const pagination = document.getElementById('recordPagination');
            pagination.innerHTML = '';
            
            if (totalPages <= 1) return;
            
            // ä¸Šä¸€é¡µ
            const prevBtn = document.createElement('button');
            prevBtn.className = `btn btn-sm btn-outline-secondary me-1`;
            prevBtn.textContent = 'Â«';
            prevBtn.disabled = currentPage === 0;
            prevBtn.onclick = () => loadRecords(currentPage - 1);
            pagination.appendChild(prevBtn);
            
            // é¡µç 
            const maxPages = 5;
            let startPage = Math.max(0, currentPage - Math.floor(maxPages / 2));
            let endPage = Math.min(totalPages, startPage + maxPages);
            
            if (endPage - startPage < maxPages) {
                startPage = Math.max(0, endPage - maxPages);
            }
            
            for (let i = startPage; i < endPage; i++) {
                const btn = document.createElement('button');
                btn.className = `btn btn-sm ${i === currentPage ? 'btn-success' : 'btn-outline-success'} me-1`;
                btn.textContent = i + 1;
                btn.onclick = () => loadRecords(i);
                pagination.appendChild(btn);
            }
            
            // ä¸‹ä¸€é¡µ
            const nextBtn = document.createElement('button');
            nextBtn.className = `btn btn-sm btn-outline-secondary`;
            nextBtn.textContent = 'Â»';
            nextBtn.disabled = currentPage === totalPages - 1;
            nextBtn.onclick = () => loadRecords(currentPage + 1);
            pagination.appendChild(nextBtn);
        }

        // åˆå§‹åŒ–
        window.onload = async () => {
            if (await checkLogin()) {
                loadStatistics();
                loadUsers(0);
                loadRecords(0);
                
                // è‡ªåŠ¨åˆ·æ–°ç»Ÿè®¡æ•°æ®ï¼ˆ30ç§’ï¼‰
                setInterval(() => {
                    loadStatistics();
                }, 30000);
            }
            
            // å¯†ç è¾“å…¥æ¡†äº‹ä»¶ç›‘å¬
            const passwordInput = document.getElementById('newPasswordInput');
            passwordInput.addEventListener('input', function() {
                checkPasswordStrength(this.value);
            });
            
            // å›è½¦é”®æäº¤
            passwordInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !document.getElementById('confirmResetBtn').disabled) {
                    confirmResetPassword();
                }
            });
            
            // ç‚¹å‡»é®ç½©å±‚å…³é—­æ¨¡æ€æ¡†
            document.getElementById('passwordModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closePasswordModal();
                }
            });
        };
    </script>
</body>
</html>
